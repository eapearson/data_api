# JavaScript API Wrappers for the Data API

The JavaScript Data API is, like the Python API, custom wrapper code on top of the JavaScript library generated by Thrift. The source code for these wrappers is in `jslib/src/js/`.

## Installation

1. Clone the GitHub repository

    Follow instructions at: https://github.com/kbase/data_api, basically:

        git clone https://github.com/kbase/data_api.git

    Change directory to the top-level of the newly cloned repository when it completes.

        cd data_api

2. (Optional; for core development) Install Python API and scripts. This will also build, and allow you to re-build, the Thrift stubs. There are two steps here, first installing Thrift itself and then installing Python libraries using the standard method (running the `setup.py` script).

    a. Install Thrift. You can install from source on any platform. See the [Thrift homepage](https://thrift.apache.org/). On Mac OSX, you can use homebrew and simply do `brew install thrift`.
    
    b. Install the Python library. The simplest thing to do here is, from the top-level directory of the repo, run the command `python setup.py install`. That is really only sensible if you are in a virtual environment, which means that you use [virtualenv/virtualenvwrapper](http://virtualenvwrapper.readthedocs.org/en/latest/) or [anaconda](https://www.continuum.io/downloads) to create one first.

3. Update JavaScript dependencies

    a. Change to the `jslib` directory and run the Node Package Manager (npm). 
    This downloads and installs a bunch of things, so it will take a couple of 
    minutes the first time, and create many screenfulls of output.

        cd jslib
        npm install

    If you have run `npm install` before, and there is nothing to do, you may just see a warning like "npm WARN package.json kbase-data-api-js@0.0.1 No repository field.". This is normal and harmless and you can ignore it.
    
    b. Change to the top-level directory and run "bower" to update JS libraries. Again, you will get some output, but this should run much faster than the previous step.
    
        cd ..
        bower update

4. Build JavaScript library. Change back down to the `jslib` directory and build the libraries with "grunt". Repeat this step every time you make changes to the local code.
    
        cd jslib
        grunt build
    
## Running


1. Change to the build directory

        cd runtime/build
        
2. **IF** you want to run in a browser window, CORS is going to be an issue. Here is how to deal with it.

    a) first install a proxy. I used `corsa`, which is a Python module available from PIP.

        pip install corsa

    b) Run the proxy from the current directory (in the background). It will run on port 8888
    
        corsa --allow-origin ALL --allow-proxy ALL --app-dir . &

    c) Run a "real" web server on port 8000, to serve static content
    
        python -m SimpleHTTPServer &

    
    
    f) Open the test page in a browser

        open "http://localhost:8888/proxy/http://localhost:8000/test1.html"

    This should contact the CORS proxy, which in turn contacts the local web server to load the page. The page itself will then send an HTTP request (through the proxy) to the Taxon service to fetch some information, and it will display it in the <div id='result'> element on the page. This will look like plain-text.

    g) You can replace the previous URL with test<N>.html to run all the other tests
    
## Testing

All the JavaScript tests and tools, unless otherwise stated, should be run from the same directory as this README, currently called `jslib`.

We use Karma and PhantomJS to run the JavaScript code. Tests run against the following browsers/platforms:
    * chrome
    * safari
    * firefox

The Karma configuration is under `test/karma.conf.js`. You shouldn't need to modify it, except perhaps for the "port:" setting if the default port conflicts with something else on your system.

Tests themselves are in `test/spec` and are usually named `test_<type>_api.js`, where "<type>" is the API name, e.g., `test_taxon_api.js`.

* Install Karma

        npm install -g karma karma-cli
    

* Install nginx and nginx-extras. nginx needs to be installed with the ["more-headers" extension](https://github.com/openresty/headers-more-nginx-module), so you need to clone that git repo first, then to install nginx itself, grab the nginx source code from [nginx.org](http://nginx.org/), for example,
   the version 1.7.10 (see [nginx compatibility](#compatibility)), and then build the source with this module:

   ```bash

    wget 'http://nginx.org/download/nginx-1.9.3.tar.gz'
    tar -xzvf nginx-1.9.3.tar.gz
    cd nginx-1.9.3/

    # Here we assume you would install you nginx under /opt/nginx/.
    ./configure --prefix=/opt/nginx \
        --add-module=/path/to/headers-more-nginx-module

    make
    make install
   ```
      
* Run nginx

        mkdir -p logs
        nginx  -p `pwd` -c nginx-testing.conf

 
* Run the Data API service of choice -- here, Taxon -- using the configuration in `data_api-test.cfg`

        data_api_start_service.py --config data_api-test.cfg --kbase_url test --service taxon &
        
    You can add `-v` for very verbose messages to stderr.

* From the same directory, run the Karma tests

        karma start test/karam.conf.js

* When you are done you can stop nginx using a `-s stop` option like this:

        nginx  -p `pwd` -c nginx-testing.conf -s stop
