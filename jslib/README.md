# JavaScript API Wrappers for the Data API

The JavaScript Data API is, like the Python API, custom wrapper code on top of the JavaScript library generated by Thrift. The source code for these wrappers is in `jslib/src/js/`.

## Installation

1. Clone the GitHub repository

    Follow instructions at: https://github.com/kbase/data_api, basically:

        git clone https://github.com/kbase/data_api.git

    Change directory to the top-level of the newly cloned repository when it completes.

        cd data_api

2. (Optional; for core development) Install Python API and scripts. This will also build, and allow you to re-build, the Thrift stubs. There are two steps here, first installing Thrift itself and then installing Python libraries using the standard method (running the `setup.py` script).

    a. Install Thrift. You can install from source on any platform. See the [Thrift homepage](https://thrift.apache.org/). On Mac OSX, you can use homebrew and simply do `brew install thrift`.
    
    b. Install the Python library. The simplest thing to do here is, from the top-level directory of the repo, run the command `python setup.py install`. That is really only sensible if you are in a virtual environment, which means that you use [virtualenv/virtualenvwrapper](http://virtualenvwrapper.readthedocs.org/en/latest/) or [anaconda](https://www.continuum.io/downloads) to create one first.

3. Update JavaScript dependencies

    a. Change to the `jslib` directory and run the Node Package Manager (npm). 
    This downloads and installs a bunch of things, so it will take a couple of 
    minutes the first time, and create many screenfulls of output.

        cd jslib
        npm install

    If you have run `npm install` before, and there is nothing to do, you may just see a warning like "npm WARN package.json kbase-data-api-js@0.0.1 No repository field.". This is normal and harmless and you can ignore it.
    
    b. Change to the top-level directory and run "bower" to update JS libraries. Again, you will get some output, but this should run much faster than the previous step.
    
        cd ..
        bower update

4. Build JavaScript library. Change back down to the `jslib` directory and build the libraries with "grunt". Repeat this step every time you make changes to the local code.
    
        cd jslib
        grunt build
    
## Running

1. For local testing, start a local copy of the Data API service. You can also use a well-known running instance of the service.


2. Configure the test authorization. Edit `jslib/runtime/config/test.yml` (initial template shown below). 
    
        ---
        cookieName: taxonApiTest
        username: YOURUSERNAME
        password: YOURPASSWORD
        loginUrl: https://ci.kbase.us/services/authorization/Sessions/Login
        taxonUrl: http://euk.kbase.us/taxon
        timeout: 1000
        objectRef: 993/329/2
    
    a. Change `username` to your KBase login name
    
    b. Change `password` to your KBase password
    
    c. You can usually leave `loginUrl` alone
    
    d. Change `taxonUrl` to the address of the DataAPI service. For a local service, this will usually be something like: `taxonUrl: http://localhost:9090`
    
    e. For local testing, change the `taxonUrl` to something that is in the `test_resources/data` directory. For testing against a CI or production KBase installation, the default is probably fine. To get a list of available Taxon object IDs, you can use the utility program in the `bin` directory called `print_msgpack_ref`:
    
        ./bin/print_msgpack_ref test_resources/data/*taxon.msgpack
    The identifier in the second column is what you should put inthe `objectRef` field in the `test.yml` file.
    
    **Important: Do NOT add the modified file to any git commits!** Doing so will make your username and password public information. In particular, do not use `git commit -a`, since this would automatically add it.
    
3. Install your changes. Run `grunt build` again to copy the new config file into the build. *Note:* You need to _re-run_ `grunt build` after any changes to the configuration file.

4. Run a web server to serve the test pages. There are of course many ways to do this. The important thing to know is that the root of the documents served should be `jslib/runtime/build`. Here are some suggestions:

    a. Run a simple Python HTTP server from that directory:

            cd jslib/runtime/build
            python -m SimpleHTTPServer 

    You can access the index page served by opening a web browser to "localhost:8000/htdocs/", e.g. from the shell:
    
        open -a Google\ Chrome 'http://localhost:8000/htdocs'
    
## Testing

Testing is configured for Karma and Jasmine. Code coverage not currently set up. All test artifacts are in the test directory.
Tests operate against the built product in runtime/build.

To test from this directory:

        karma start test/karam.conf.js

Tests are set up to run against Chrome, Firefox, Safari, and PhantomJS. I can't confirm PhantomJS, because it is not currently working. There are JS compatability bugs in PhantomJS < 2.0, but 2.0 does not build on El Capitan at the moment (qt5 compatiblity issues...)